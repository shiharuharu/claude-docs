name: Sync Claude Documentation

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  issues: write

jobs:
  sync-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fetch all documentation
        id: fetch-docs
        run: |
          python scripts/fetch_all.py || echo "fetch_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate commit message
        if: steps.changes.outputs.has_changes == 'true'
        id: commit-msg
        run: |
          CHANGED=$(git diff --name-status --cached | grep "^M" | cut -f2 | grep -E "\.md$" | wc -l | tr -d ' ')
          ADDED=$(git diff --name-status --cached | grep "^A" | cut -f2 | grep -E "\.md$" | wc -l | tr -d ' ')
          DELETED=$(git diff --name-status --cached | grep "^D" | cut -f2 | grep -E "\.md$" | wc -l | tr -d ' ')

          MSG="docs: sync Claude documentation $(date -u +%Y-%m-%d)"

          DETAILS=""
          if [ "$CHANGED" != "0" ]; then
            DETAILS="${DETAILS} | ${CHANGED} updated"
          fi
          if [ "$ADDED" != "0" ]; then
            DETAILS="${DETAILS} | ${ADDED} added"
          fi
          if [ "$DELETED" != "0" ]; then
            DETAILS="${DETAILS} | ${DELETED} removed"
          fi

          if [ -n "$DETAILS" ]; then
            MSG="${MSG}${DETAILS}"
          fi

          echo "message=$MSG" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "${{ steps.commit-msg.outputs.message }}"
          git push

      - name: Create issue on failure
        if: steps.fetch-docs.outputs.fetch_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sync-failure'
            });
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Documentation sync failed - ${date}`,
                body: `The automated documentation sync failed on ${date}.\n\nPlease check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
                labels: ['bug', 'sync-failure']
              });
            }
